---
# === MISP INSTALLATION (Ubuntu 22.04) ===

# --- Base dependencies ---
- name: Install MISP dependencies
  apt:
    name:
      - curl
      - wget
      - git
      - gnupg
      - unzip
      - zip
      - redis-server
      - mariadb-server
      - apache2
      - apache2-utils
      - python3
      - python3-pip
      - python3-venv
      - php
      - php-mysql
      - php-redis
      - php-cli
      - php-xml
      - php-mbstring
      - php-zip
      - php-bcmath
      - php-gd
      - php-curl
      - php-intl
      - libapache2-mod-php
    update_cache: yes
    state: present

# --- Enable services ---
- name: Ensure MariaDB and Redis are started and enabled
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - mariadb
    - redis-server

# --- Database setup ---
- name: Create MISP database and user
  shell: |
    mysql -e "CREATE DATABASE IF NOT EXISTS misp;"
    mysql -e "CREATE USER IF NOT EXISTS 'misp'@'localhost' IDENTIFIED BY 'MispPass123!';"
    mysql -e "GRANT ALL PRIVILEGES ON misp.* TO 'misp'@'localhost';"
    mysql -e "FLUSH PRIVILEGES;"

# --- Clone MISP ---
- name: Clone MISP repository
  git:
    repo: "https://github.com/MISP/MISP.git"
    dest: /var/www/MISP
    version: "2.4"
    force: yes

- name: Initialize and update MISP submodules
  shell: |
    cd /var/www/MISP
    git submodule update --init --recursive
  args:
    chdir: /var/www/MISP

# --- Permissions ---
- name: Ensure correct ownership for MISP directory
  file:
    path: /var/www/MISP
    owner: www-data
    group: www-data
    recurse: yes

- name: Ensure tmp and cache directories exist and are writable
  file:
    path: "{{ item }}"
    state: directory
    owner: www-data
    group: www-data
    mode: "0775"
  loop:
    - /var/www/MISP/app/tmp
    - /var/www/MISP/app/tmp/cache
    - /var/www/MISP/app/tmp/logs

# --- Apache Configuration ---
- name: Create Apache virtual host for MISP
  copy:
    dest: /etc/apache2/sites-available/misp.conf
    content: |
      <VirtualHost *:80>
          ServerAdmin admin@misp.local
          ServerName misp.innovatech.internal
          DocumentRoot /var/www/MISP/app/webroot

          <Directory /var/www/MISP/app/webroot>
              Options -Indexes
              AllowOverride All
              Require all granted
          </Directory>

          ErrorLog ${APACHE_LOG_DIR}/misp_error.log
          CustomLog ${APACHE_LOG_DIR}/misp_access.log combined
      </VirtualHost>

- name: Enable Apache modules and MISP site
  shell: |
    a2dissite 000-default.conf || true
    a2ensite misp.conf
    a2enmod rewrite
    systemctl reload apache2

# --- MISP Configuration Files ---
- name: Deploy config.php
  template:
    src: config.php.j2
    dest: /var/www/MISP/app/Config/config.php
    owner: www-data
    group: www-data
    mode: "0644"

- name: Deploy database.php for CakePHP
  template:
    src: database.php.j2
    dest: /var/www/MISP/app/Config/database.php
    owner: www-data
    group: www-data
    mode: "0644"

# --- Permissions fix ---
- name: Finalize ownership and permissions
  file:
    path: /var/www/MISP
    owner: www-data
    group: www-data
    recurse: yes

# --- Restart Apache ---
- name: Restart Apache service
  systemd:
    name: apache2
    state: restarted
    enabled: yes

# --- Health checks ---
- name: Wait for Apache to be ready
  wait_for:
    host: 127.0.0.1
    port: 80
    delay: 5
    timeout: 30

- name: Verify MISP is reachable
  uri:
    url: "http://localhost"
    return_content: no
  register: misp_status
  failed_when: misp_status.status not in [200, 302]
