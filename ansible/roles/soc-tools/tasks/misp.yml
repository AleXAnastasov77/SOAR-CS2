- name: Download official MISP installer
  get_url:
    url: https://raw.githubusercontent.com/MISP/MISP/2.4/INSTALL/INSTALL.sh
    dest: /tmp/INSTALL.sh
    mode: "0755"

- name: Patch INSTALL.sh to remove /dev/tty usage
  shell: |
    sed -i 's|/dev/tty|/dev/null|g' /tmp/INSTALL.sh
    sed -i 's|tput||g' /tmp/INSTALL.sh

- name: Run official MISP installer (unattended core + modules)
  shell: |
    export DEBIAN_FRONTEND=noninteractive
    export TERM=dumb
    MISP_USER=misp \
    MISP_PASSWORD=misp \
    DBUSER_ADMIN=root \
    DBPASSWORD_ADMIN=root \
    DBUSER_MISP=misp \
    DBPASSWORD_MISP=misp \
    bash /tmp/INSTALL.sh -c -M -u
  args:
    creates: /var/www/MISP/app/webroot



- name: Check if MISP web interface is reachable
  uri:
    url: "http://localhost"
    status_code: 200
    return_content: no
  register: misp_health
  retries: 10
  delay: 10
  until: misp_health.status == 200

- name: Print MISP health status
  debug:
    msg: "âœ… MISP is reachable and returned status {{ misp_health.status }}"