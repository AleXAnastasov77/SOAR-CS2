# === MISP INSTALLATION (Ubuntu 22.04) ===

- name: Install MISP dependencies
  apt:
    name:
      - curl
      - wget
      - git
      - gnupg
      - unzip
      - zip
      - redis-server
      - mariadb-server
      - apache2
      - apache2-utils
      - python3
      - python3-pip
      - python3-venv
      - php
      - php-mysql
      - php-redis
      - php-cli
      - php-xml
      - php-mbstring
      - php-zip
      - php-bcmath
      - php-gd
      - php-curl
      - libapache2-mod-php
    update_cache: yes
    state: present

- name: Ensure MariaDB and Redis are enabled
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - mariadb
    - redis-server

# --- Database setup ---
- name: Secure MariaDB installation
  shell: |
    mysql -e "CREATE DATABASE IF NOT EXISTS misp;"
    mysql -e "CREATE USER IF NOT EXISTS 'misp'@'localhost' IDENTIFIED BY 'MispPass123!';"
    mysql -e "GRANT ALL PRIVILEGES ON misp.* TO 'misp'@'localhost';"
    mysql -e "FLUSH PRIVILEGES;"

# --- Clone MISP ---
- name: Clone MISP repository
  git:
    repo: "https://github.com/MISP/MISP.git"
    dest: /var/www/MISP
    version: "2.4"
    force: yes

- name: Set ownership for MISP directory
  file:
    path: /var/www/MISP
    owner: www-data
    group: www-data
    recurse: yes

# --- Apache configuration ---
- name: Create Apache site for MISP
  copy:
    dest: /etc/apache2/sites-available/misp.conf
    content: |
      <VirtualHost *:80>
          ServerAdmin admin@misp.local
          ServerName misp.innovatech.internal
          DocumentRoot /var/www/MISP/app/webroot

          <Directory /var/www/MISP/app/webroot>
              Options -Indexes
              AllowOverride All
              Require all granted
          </Directory>

          ErrorLog ${APACHE_LOG_DIR}/misp_error.log
          CustomLog ${APACHE_LOG_DIR}/misp_access.log combined
      </VirtualHost>

- name: Enable Apache modules and site
  shell: |
    a2dissite 000-default.conf || true
    a2ensite misp.conf
    a2enmod rewrite
    systemctl reload apache2

# --- MISP Configuration ---
- name: Copy default MISP config.php
  template:
    src: config.php.j2
    dest: /var/www/MISP/app/Config/config.php
    owner: www-data
    group: www-data
    mode: "0644"

- name: Set correct permissions for MISP files
  file:
    path: /var/www/MISP
    owner: www-data
    group: www-data
    recurse: yes

- name: Restart Apache to apply MISP configuration
  systemd:
    name: apache2
    state: restarted
    enabled: yes
